# Solar Tracker

根據太陽位置計算，透過兩個伺服馬達自動調整太陽能板的方向，以達到最佳發電效果。系統會自動追蹤太陽從日出到日落的路徑，並在夜間時將太陽能板預先調整至隔日日出位置，實現能源收集的最大化。

## 系統元件

1. Xiao ESP32C6 開發板
2. DS3120mg 水平伺服馬達（角度範圍：270度）
3. DS3210mg 垂直伺服馬達（角度範圍：180度）
4. 5V 400mA 太陽能電池板
5. 三腳微動開關 x 2（用於手動模式控制）
6. LiFePO4 電池 (2x6000mAh, 3.2V) 提供電力輸入至 5V 穩壓模組

## 電路連接圖

(Generated by AI, Claude 3.7 sonnet)
![Solar Tracker Circuit Diagram](./Solar_Tracker_Circuit.svg)

*電路連接說明:*

- Xiao ESP32C6 通過 GPIO16 控制水平伺服馬達 (DS3120mg)
- Xiao ESP32C6 通過 GPIO17 控制垂直伺服馬達 (DS3210mg)
- 手動重置開關連接到 GPIO20
- 當前位置開關連接到 GPIO19
- LiFePO4 電池 (10000mAh, 3.2V) 與太陽能板 (5V, 400mA) 並聯
- 5V 穩壓模組將 3.2V 輸入轉換為 5V 輸出，為所有元件供電

## 工作原理

### 太陽位置計算

本專案使用基於地理位置（經緯度）和當前時間的太陽方位角和仰角計算公式：

1. 系統通過 WiFi 連接網路，並使用 NTP 服務器同步時間
2. `SunPosition` 類別根據當前時間、地理位置計算太陽的方位角和仰角
3. 方位角轉換為水平伺服馬達角度，仰角轉換為垂直伺服馬達角度

### 運作模式

系統有三種主要運作模式：

1. **日間追蹤模式**：太陽高度角 > 0 度時自動啟動，持續追蹤太陽位置
2. **夜間準備模式**：日落後自動計算隔日日出位置，並將太陽能板預先調整至該位置
3. **手動重置模式**：通過 MANUAL_RESET_POS_PIN 引腳觸發，將太陽能板重置到預設位置（水平135度，垂直0度）

### 伺服馬達控制

系統通過精確的脈衝寬度調制 (PWM) 信號控制伺服馬達：

- 水平伺服馬達：0-270度範圍，對應500-2500微秒脈衝寬度
- 垂直伺服馬達：0-180度範圍，對應580-2480微秒脈衝寬度
- 為防止馬達過熱，系統使用漸進式移動策略，限制每次最大移動角度為5度

## 數據監控設定

本系統整合了 VictoriaMetrics 和 Grafana 來監控和視覺化太陽追蹤器的運行數據：

1. VictoriaMetrics 用於時間序列數據存儲，系統每60秒發送一次指標數據
2. 追蹤的指標包括：
   - 太陽方位角和仰角
   - 伺服馬達水平和垂直位置
   - 夜間模式狀態
3. Grafana 儀表板呈現這些指標的變化趨勢

### 設定步驟

VictoriaMetrics：從[GitHub](https://github.com/VictoriaMetrics/VictoriaMetrics/releases)下載執行檔，解壓縮後執行指令`victoria-metrics-prod -retentionPeriod=100y`啟動服務。

Grafana：使用作業系統套件安裝；或從[官網下載](https://grafana.com/grafana/download)檔案，解壓縮後執行`bin/grafana`啟動服務。

## 安裝與設定

### 硬體安裝

1. 將水平伺服馬達連接到 ESP32C6 的 GPIO16 針腳
2. 將垂直伺服馬達連接到 ESP32C6 的 GPIO17 針腳
3. 將手動重置開關連接到 GPIO20 針腳
4. 將當前位置開關連接到 GPIO19 針腳

<img src="IMG_3586.jpeg" alt="IMG_3586" style="zoom: 33%;" />

### 軟體設定

1. 修改 `config_secret.h` 文件中的 WiFi 憑證：
```c
const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";
```

2. 根據您的地理位置更新經緯度（預設為高雄市）：
```c
const double LATITUDE = 22.6273;
const double LONGITUDE = 120.3014;
```

3. 如需啟用指標收集功能，取消註釋以下行：
```c
// #define ENABLE_METRIC_COLLECT
```

4. 修改 VictoriaMetrics 設定指向您的服務器：
```c
const char* vmHost = "http://YOUR_VM_SERVER_IP:8428";
const char* deviceName = "YOUR_DEVICE_NAME";
```

## 校準與調整

根據實際組裝的伺服馬達規格，設定轉動範圍。

```c++
// 伺服馬達範圍設定
const int HORIZONTAL_SERVO_MIN_ANGLE = 0;    // 水平伺服馬達最大角度為270度
const int HORIZONTAL_SERVO_MAX_ANGLE = 270;  // 水平伺服馬達最大角度為270度
const int VERTICAL_SERVO_MIN_ANGLE = 0;      // 垂直伺服馬達最大角度為180度
const int VERTICAL_SERVO_MAX_ANGLE = 180;    // 垂直伺服馬達最大角度為180度

```

我的伺服馬達訊號範圍有些細微偏差，依照實際觀察到的轉動角度，設定 PWM 範圍如下：

```c++

// 伺服馬達脈衝範圍（微秒）
const int HORIZONTAL_SERVO_MIN_PULSE = 500;   // 對應0度位置
const int HORIZONTAL_SERVO_MAX_PULSE = 2500;  // 對應270度位置
const int VERTICAL_SERVO_MIN_PULSE = 580;     // 對應0度位置
const int VERTICAL_SERVO_MAX_PULSE = 2480;    // 對應180度位置
```

## 成品演示

實際運行中的太陽追蹤器縮時攝影：https://youtube.com/shorts/aTHwb26RYuk?si=8in0Wzu5c7Vx6CHZ

## 系統限制

- 系統啟動時，需要穩定的 WiFi 連接才能獲取準確時間，進而計算太陽位置
- 伺服馬達可能需要定期校準以維持精確度
- 當太陽在正上方（仰角>85度）時，水平伺服馬達會固定指向南方（135度），以避免水平馬達大解度轉動。

## 實作心得

### 已知問題

- 理論上伺服馬達未轉動時不耗電，但實際上有時候會消耗將近 100mA 電動。根據觀察應該是實際角度沒有到達目標角度，造成馬達一直要轉動但又一直轉不到目標，這時候會出現高頻聲音。
- 承上所述，對於輕負載且小角度轉動，伺服馬達有機會出現持續耗電的情況，從太陽能獲得的電力還不足以支撐伺服馬達運作廿四小時。

### 未來改進方向

- 可加上時鐘模組（RTC）避免依賴 WiFi 網路，實現離線運行。
- 增加耗電量監測功能
  - 在伺服馬達發生靜止耗電的情況時，做一次大角度來回轉動，看能否解決問題。
  - 在伺服馬達靜止時，切斷電源；在需要轉動時，恢復電源。

